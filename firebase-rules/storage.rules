rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // images for projects
    match /projects/{projectId}/images/{imagePath=**} {
      // Allow upload only if authenticated and metadata.uploaderUid == auth.uid
      allow write: if request.auth != null
                   && request.resource != null
                   && request.resource.size < 5 * 1024 * 1024 // max 5MB in rules
                   && request.resource.metadata.uploaderUid == request.auth.uid;

      // Allow read if authenticated AND (uploader OR office role)
      allow read: if request.auth != null && (
                    resource.metadata.uploaderUid == request.auth.uid ||
                    firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == "office"
                  );

      // Allow delete only for office role
      allow delete: if request.auth != null
                    && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == "office";
    }
  }
}
